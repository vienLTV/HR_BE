.deploy-dev-template:
  stage: deploy-dev
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  before_script:
    - apk add --no-cache openssh-client docker-cli
    - echo "$SSH_PRIVATE_KEY" > id_rsa
    - chmod 400 id_rsa
  script:
    - echo "Deploying application to $TENANT_NAME..."
    - ssh -o StrictHostKeyChecking=no -i id_rsa $SSH_USER@$SSH_HOST "
      set -e &&
      cd $PROJECT_PATH &&
      sudo git reset --hard &&
      sudo git pull origin develop &&
      sudo docker rm -f $DOCKER_CONTAINER || true &&
      sudo docker rmi \$(docker images -q $DOCKER_IMAGE_NAME) || true &&
      sudo docker compose down &&
      sudo docker compose up -d
      "
    - echo "Deployed Successfully"

docker-build:
  stage: docker-build
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u $DOCKER_USERNAME --password-stdin
  script:
    - docker build -f src/main/docker/Dockerfile.jvm -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} .
    - docker push ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
  dependencies:
    - maven-build

deploy-dev-southeast-asia:
  extends: .deploy-dev-template
  variables:
    TENANT_NAME: southeast-asia
    PROJECT_PATH: /opt/cetus-app/cetus-core/

post-deploy-dev:
  stage: post-deploy-dev
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  script:
    - echo "Finished Deployment"